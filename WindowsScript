#requires -RunAsAdministrator
param(
    [switch]$EnableRdp,
    [switch]$SkipDefenderScan,
    [switch]$SkipShareCleanup
)

$Global:LogPath = Join-Path $PSScriptRoot "cyberpatriot-hardening.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $line = "{0:u} [{1}] {2}" -f (Get-Date), $Level, $Message
    $line | Tee-Object -FilePath $LogPath -Append
}

function Assert-Admin {
    $principal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        throw "Run this script from an elevated PowerShell session."
    }
}

function Set-ExplorerHiddenItems {
    Write-Log "Showing hidden files and protected OS files in File Explorer."
    $path = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced'
    Set-ItemProperty -Path $path -Name Hidden -Value 1 -Force
    Set-ItemProperty -Path $path -Name ShowSuperHidden -Value 1 -Force
    Set-ItemProperty -Path $path -Name HideFileExt -Value 0 -Force
}

function Enable-FirewallProfiles {
    Write-Log "Enabling firewall for all profiles."
    Set-NetFirewallProfile -Profile Domain,Private,Public -Enabled True
}


function Invoke-DefenderScan {
    if ($SkipDefenderScan) {
        Write-Log "Skipping Defender scan per parameter." "WARN"
        return
    }
    Write-Log "Starting Microsoft Defender quick scan."
    Start-MpScan -ScanType QuickScan | Out-Null
}

function Apply-PasswordPolicy {
    Write-Log "Applying password policy via net accounts and secedit."
    net accounts /maxpwage:90 /minpwage:15 /uniquepw:7 | Out-Null
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SAM" /v RelaxMinimumPasswordLengthLimits /t REG_DWORD /d 0 /f | Out-Null

    $tempCfg = Join-Path $env:TEMP "cp-pwd.inf"
    secedit /export /cfg $tempCfg | Out-Null
    $cfg = Get-Content $tempCfg -Raw
    if ($cfg -notmatch '\[System Access\]') { $cfg += "`r`n[System Access]`r`n" }

    $cfg = $cfg -replace 'MinimumPasswordAge\s*=.*', 'MinimumPasswordAge = 15'
    $cfg = $cfg -replace 'MaximumPasswordAge\s*=.*', 'MaximumPasswordAge = 90'
    $cfg = $cfg -replace 'PasswordHistorySize\s*=.*', 'PasswordHistorySize = 7'
    $cfg = $cfg -replace 'PasswordComplexity\s*=.*', 'PasswordComplexity = 1'
    $cfg = $cfg -replace 'ClearTextPassword\s*=.*', 'ClearTextPassword = 0'
    $cfg = $cfg -replace 'LockoutBadCount\s*=.*', 'LockoutBadCount = 5'
    $cfg = $cfg -replace 'ResetLockoutCount\s*=.*', 'ResetLockoutCount = 30'
    $cfg = $cfg -replace 'LockoutDuration\s*=.*', 'LockoutDuration = 30'

    $cfg | Set-Content $tempCfg -Encoding Unicode
    secedit /configure /db secedit.sdb /cfg $tempCfg /overwrite | Out-Null
    Remove-Item $tempCfg -ErrorAction SilentlyContinue
}

function Apply-AuditPolicies {
    Write-Log "Enabling success/failure auditing for all categories."
    auditpol /set /category:* /success:enable /failure:enable | Out-Null
}

function Enforce-ServiceConfiguration {
    Write-Log "Aligning critical service states."

    $rdpStartup = "Disabled"
    $rdpState   = "Stopped"
    if ($EnableRdp) {
        $rdpStartup = "Manual"
        $rdpState   = "Running"
    }

    $serviceMatrix = @(
        @{Name="RemoteRegistry";       Startup="Disabled";  State="Stopped"},
        @{Name="SNMPTRAP";             Startup="Disabled";  State="Stopped"},
        @{Name="FTPSVC";               Startup="Disabled";  State="Stopped"},
        @{Name="W3SVC";                Startup="Disabled";  State="Stopped"},
        @{Name="TlntSvr";              Startup="Disabled";  State="Stopped"},
        @{Name="upnphost";             Startup="Disabled";  State="Stopped"},
        @{Name="RemoteAccess";         Startup="Disabled";  State="Stopped"},
        @{Name="TermService";          Startup=$rdpStartup; State=$rdpState},
        @{Name="Wecsvc";               Startup="Automatic"; State="Running"},
        @{Name="EventLog";             Startup="Automatic"; State="Running"},
        @{Name="wscsvc";               Startup="Automatic"; State="Running"},
        @{Name="SamSs";                Startup="Automatic"; State="Running"},
        @{Name="ProfSvc";              Startup="Automatic"; State="Running"},
        @{Name="Search";               Startup="Automatic"; State="Running"},
        @{Name="SecurityHealthService";Startup="Manual";    State="Running"},
        @{Name="wuauserv";             Startup="Automatic"; State="Running"},
        @{Name="bthserv";              Startup="Disabled";  State="Stopped"},
        @{Name="XblAuthManager";       Startup="Disabled";  State="Stopped"},
        @{Name="XblGameSave";          Startup="Disabled";  State="Stopped"},
        @{Name="XboxNetApiSvc";        Startup="Disabled";  State="Stopped"}
    )

    foreach ($svc in $serviceMatrix) {
        try {
            Set-Service -Name $svc.Name -StartupType $svc.Startup -ErrorAction Stop
            if ($svc.State -eq "Running") {
                Start-Service -Name $svc.Name -ErrorAction Stop
            } elseif ($svc.State -eq "Stopped") {
                Stop-Service -Name $svc.Name -Force -ErrorAction Stop
            }
        } catch {
            Write-Log "Service $($svc.Name) missing or cannot be modified: $_" "WARN"
        }
    }
}

function Harden-RemoteDesktop {
    $denyValue = if ($EnableRdp) { 0 } else { 1 }
    Write-Log "Configuring Remote Desktop and Remote Assistance (EnableRdp = $EnableRdp)."
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value $denyValue -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fAllowToGetHelp -Value 0 -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name UserAuthentication -Value 1 -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name SecurityLayer -Value 2 -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name MinEncryptionLevel -Value 3 -Force
}

function Disable-AutoPlay {
    Write-Log "Disabling AutoPlay/AutoRun for all drives."
    New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies" -Name Explorer -Force | Out-Null
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name NoDriveTypeAutoRun -Value 255 -Force
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\AutoplayHandlers" -Name DisableAutoplay -Value 1 -Force
}

function Enable-WindowsSecurityRecommendations {
    Write-Log "Applying baseline Microsoft Defender preferences."
    Set-MpPreference -DisableRealtimeMonitoring $false `
        -PUAProtection Enabled `
        -MAPSReporting Advanced `
        -SubmitSamplesConsent SendSafeSamples `
        -DisableIOAVProtection $false `
        -SignatureScheduleDay Everyday `
        -SignatureScheduleTime 120
    Set-ProcessMitigation -System -Enable DEP,CFG | Out-Null
    try {
        Set-MpPreference -DisableIntrusionPreventionSystem $false -ErrorAction Stop
    } catch {
        Write-Log "Couldn't update advanced Defender preferences: $_" "WARN"
    }
}

function Disable-BluetoothStack {
    Write-Log "Disabling Bluetooth radios and discoverability."
    Stop-Service -Name bthserv -Force -ErrorAction SilentlyContinue
    Set-Service -Name bthserv -StartupType Disabled -ErrorAction SilentlyContinue
    try {
        $btKey = "HKLM:\SYSTEM\CurrentControlSet\Services\BTHPORT\Parameters\General"
        if (-not (Test-Path $btKey)) {
            New-Item -Path $btKey -Force | Out-Null
        }
        Set-ItemProperty -Path $btKey -Name EnableOffload -Value 0 -Force
    } catch {
        Write-Log "Bluetooth registry tweak skipped: $_" "WARN"
    }
}

function Configure-NetworkSecurity {
    Write-Log "Hardening IPv6 and anonymous access settings."
    New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters" -Force | Out-Null
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters" -Name DisabledComponents -Value 255 -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v LimitBlankPasswordUse /t REG_DWORD /d 1 /f | Out-Null
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v NoLMHash /t REG_DWORD /d 1 /f | Out-Null
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v RestrictAnonymous /t REG_DWORD /d 1 /f | Out-Null
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v RestrictAnonymousSAM /t REG_DWORD /d 1 /f | Out-Null
}

function Remove-UnapprovedShares {
    if ($SkipShareCleanup) {
        Write-Log "Skipping share cleanup per parameter." "WARN"
        return
    }
    Write-Log "Removing non-standard SMB shares."
    $allowedShares = @("ADMIN$","C$","IPC$")
    try {
        $shares = Get-SmbShare | Where-Object { $_.Name -notin $allowedShares }
        foreach ($share in $shares) {
            Remove-SmbShare -Name $share.Name -Force
            Write-Log "Removed share $($share.Name)."
        }
    } catch {
        Write-Log "SMB share enumeration failed (likely non-Pro SKU): $_" "WARN"
    }
}

function Cleanup-MusicFolder {
    $music = Join-Path $env:USERPROFILE "Music"
    if (-not (Test-Path $music)) { return }
    Write-Log "Deleting media files from $music."
    Get-ChildItem -Path $music -Include *.mp3,*.mp4,*.mov -File -Recurse -ErrorAction SilentlyContinue |
        Remove-Item -Force -ErrorAction SilentlyContinue
}

function Configure-LocalAccounts {
    Write-Log "Disabling default Administrator/Guest accounts and blocking Microsoft accounts."
    net user Administrator /active:no | Out-Null
    net user Guest /active:no | Out-Null
    reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v NoConnectedUser /t REG_DWORD /d 3 /f | Out-Null
}

function Apply-UserRightsTemplate {
    Write-Log "Applying privilege rights and key security options via secedit."
    $infPath = Join-Path $env:TEMP "cp-security.inf"
    $inf = @"
[Unicode]
Unicode=yes
[Version]
signature="$CHICAGO$"
Revision=1
[System Access]
MinimumPasswordAge = 15
MaximumPasswordAge = 90
PasswordHistorySize = 7
PasswordComplexity = 1
ClearTextPassword = 0
LockoutBadCount = 5
ResetLockoutCount = 30
LockoutDuration = 30

[Event Audit]
AuditSystemEvents = 3
AuditLogonEvents = 3
AuditObjectAccess = 3
AuditPrivilegeUse = 3
AuditPolicyChange = 3
AuditAccountManage = 3
AuditProcessTracking = 3
AuditDSAccess = 3
AuditAccountLogon = 3

[Privilege Rights]
SeTrustedCredManAccessPrivilege =
SeNetworkLogonRight = *S-1-5-32-544
SeTcbPrivilege =
SeIncreaseQuotaPrivilege = *S-1-5-32-544,*S-1-5-19,*S-1-5-20
SeInteractiveLogonRight = *S-1-5-32-544,*S-1-5-32-545
SeRemoteInteractiveLogonRight = *S-1-5-32-544,*S-1-5-32-555
SeBackupPrivilege = *S-1-5-32-544
SeSystemtimePrivilege = *S-1-5-32-544,*S-1-5-19
SeTimeZonePrivilege = *S-1-5-32-544,*S-1-5-19,*S-1-5-32-545
SeCreatePagefilePrivilege = *S-1-5-32-544
SeCreateTokenPrivilege =
SeCreateGlobalPrivilege = *S-1-5-32-544,*S-1-5-19,*S-1-5-20,*S-1-5-6
SeCreatePermanentPrivilege =
SeCreateSymbolicLinkPrivilege = *S-1-5-32-544
SeDebugPrivilege = *S-1-5-32-544
SeDenyNetworkLogonRight = *S-1-5-32-546,*S-1-5-113
SeDenyBatchLogonRight = *S-1-5-32-546
SeDenyServiceLogonRight = *S-1-5-32-546
SeDenyInteractiveLogonRight = *S-1-5-32-546
SeDenyRemoteInteractiveLogonRight = *S-1-5-32-546,*S-1-5-113
SeEnableDelegationPrivilege =
SeRemoteShutdownPrivilege = *S-1-5-32-544
SeAuditPrivilege = *S-1-5-19,*S-1-5-20
SeImpersonatePrivilege = *S-1-5-32-544,*S-1-5-19,*S-1-5-20,*S-1-5-6
SeIncreaseBasePriorityPrivilege = *S-1-5-32-544
SeLoadDriverPrivilege = *S-1-5-32-544
SeLockMemoryPrivilege =
SeBatchLogonRight = *S-1-5-32-544
SeServiceLogonRight =
SeSecurityPrivilege = *S-1-5-32-544
SeRelabelPrivilege =
SeSystemEnvironmentPrivilege = *S-1-5-32-544
SeManageVolumePrivilege = *S-1-5-32-544
SeProfileSingleProcessPrivilege = *S-1-5-32-544
SeSystemProfilePrivilege = *S-1-5-32-544
SeAssignPrimaryTokenPrivilege = *S-1-5-19,*S-1-5-20
SeRestorePrivilege = *S-1-5-32-544
SeShutdownPrivilege = *S-1-5-32-544,*S-1-5-32-545
SeTakeOwnershipPrivilege = *S-1-5-32-544

[Registry Values]
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DontDisplayLastUserName=4,1
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DisableCAD=4,0
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\InactivityTimeoutSecs=4,900
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ScRemoveOption=4,1
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\PromptOnSecureDesktop=4,1
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA=4,1
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorAdmin=4,2
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorUser=4,0
MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken=4,1
MACHINE\System\CurrentControlSet\Control\Lsa\LimitBlankPasswordUse=4,1
MACHINE\System\CurrentControlSet\Control\Lsa\ForceGuest=4,0
MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=4,1
MACHINE\System\CurrentControlSet\Control\Lsa\DisableDomainCreds=4,1
MACHINE\System\CurrentControlSet\Control\Lsa\UseMachineId=4,1
MACHINE\System\CurrentControlSet\Control\Lsa\SCENoApplyLegacyAuditPolicy=4,1
MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential=4,0
MACHINE\System\CurrentControlSet\Control\Terminal Server\fAllowToGetHelp=4,0
MACHINE\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\UserAuthentication=4,1
MACHINE\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer=4,2
"@
    $inf | Set-Content -Path $infPath -Encoding Unicode
    secedit /configure /db secedit.sdb /cfg $infPath /overwrite | Out-Null
    Remove-Item $infPath -ErrorAction SilentlyContinue
}

function Hardening-Reminder {
    Write-Log "Reminder: run Malwarebytes + PatchMyPC manually and adjust users per README." "WARN"
}

function Invoke-SystemHardening {
    Assert-Admin
    Write-Log "----- CyberPatriot Hardening Started -----"
    Set-ExplorerHiddenItems
    Enable-FirewallProfiles
    Enable-WindowsSecurityRecommendations
    Invoke-DefenderScan
    Apply-PasswordPolicy
    Apply-AuditPolicies
    Apply-UserRightsTemplate
    Configure-LocalAccounts
    Configure-NetworkSecurity
    Enforce-ServiceConfiguration
    Harden-RemoteDesktop
    Disable-AutoPlay
    Disable-BluetoothStack
    Remove-UnapprovedShares
    Cleanup-MusicFolder
    Hardening-Reminder
    Write-Log "----- CyberPatriot Hardening Complete -----"
}

Invoke-SystemHardening